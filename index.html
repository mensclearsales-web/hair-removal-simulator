<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEN'S CLEAR 脱毛料金シミュレーター</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  background: #f6f9fc;
  color: #333;
}

header {
  background: #0b4fa8;
  color: #fff;
  padding: 14px 20px;
  font-size: 20px;
  font-weight: bold;
}

.wrap {
  padding: 20px;
  max-width: 1100px;
  margin: auto;
}

h1 {
  font-size: 26px;
  margin-bottom: 10px;
}

h2 {
  margin-top: 40px;
  border-left: 6px solid #0b4fa8;
  padding-left: 10px;
  font-size: 22px;
}

.row {
  margin: 18px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

label {
  display: flex;
  flex-direction: column;
  font-size: 14px;
  min-width: 240px;
}

input, select {
  padding: 8px;
  margin-top: 4px;
  font-size: 15px;
}

input[readonly] {
  background: #eaeaea;
  font-weight: bold;
}

/* 追加ボタン */
.btn-wrap button {
  padding: 10px 18px;
  background: #0b4fa8;
  color: #fff;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  font-size: 15px;
}
.btn-wrap button:hover {
  opacity: 0.8;
}

/* テーブル */
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}
th, td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: center;
}

/* 結果カード */
.cards {
  display: grid;
  gap: 20px;
}
.cards.two-col {
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}
.card {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.card h3 {
  margin: 0;
  font-size: 18px;
  color: #666;
}
.card p {
  margin-top: 10px;
  font-size: 24px;
  font-weight: bold;
}
.highlight {
  background: #e8f0ff;
  border-left: 5px solid #0b4fa8;
}

/* タブ */
.tabs {
  display: flex;
  gap: 10px;
  margin: 20px 0;
}
.tab {
  padding: 10px 18px;
  background: #dce7f7;
  cursor: pointer;
  border-radius: 6px;
  font-weight: bold;
}
.tab.active {
  background: #0b4fa8;
  color: #fff;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
</style>
</head>
<body>
<header>MEN'S CLEAR 料金シミュレーター</header>
<div class="wrap">
  <h1>脱毛料金 & 分割シミュレーション</h1>
  <div class="tabs">
    <div class="tab active" data-tab="campaign">キャンペーン</div>
    <div class="tab" data-tab="normal">通常料金</div>
  </div>
  <!-- キャンペーンタブ -->
  <section id="tab-campaign" class="tab-content active">
    <div class="wrap">
      <h2>キャンペーンプラン（12月版）</h2>
code
Code
<div class="row">
    <label>編集ターゲット：
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button type="button" class="pill active" data-target="matsu">プラン①</button>
        <button type="button" class="pill" data-target="take">プラン②</button>
        <button type="button" class="pill" data-target="ume">プラン③</button>
      </div>
    </label>
  </div>

  <div class="row">
    <label>カテゴリ
      <select id="cat-select-c">
        <option value="ヒゲ">ヒゲ</option>
        <option value="フェイス">フェイス</option>
        <option value="どこでも脱毛20分">どこでも脱毛20分</option>
        <option value="どこでも脱毛40分">どこでも脱毛40分</option>
        <option value="全身+ヒゲor陰部">全身+ヒゲor陰部</option>
        <option value="全身オール">全身オール</option>
        <option value="陰部">陰部</option>
      </select>
    </label>

    <label>プラン
      <select id="plan-select-c"></select>
    </label>
  </div>

  <div class="row">
    <label>選択プラン金額（税込）
      <input id="selected-plan-price-c" readonly value="0">
    </label>
    <div class="btn-wrap">
      <button id="add-plan-c" type="button">＋追加</button>
    </div>
  </div>

  <!-- 比較カード -->
  <div class="row">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;width:100%;">
      <div class="card" id="card-matsu">
        <h3>プラン①</h3>
        <p id="price-matsu">¥0</p>
        <div id="planlist-matsu" style="white-space:pre-line;color:#0b4fa8;font-weight:700;margin-top:8px;">（プラン未選択）</div>
      </div>
      <div class="card" id="card-take">
        <h3>プラン②</h3>
        <p id="price-take">¥0</p>
        <div id="planlist-take" style="white-space:pre-line;color:#0b4fa8;font-weight:700;margin-top:8px;">（プラン未選択）</div>
      </div>
      <div class="card" id="card-ume">
        <h3>プラン③</h3>
        <p id="price-ume">¥0</p>
        <div id="planlist-ume" style="white-space:pre-line;color:#0b4fa8;font-weight:700;margin-top:8px;">（プラン未選択）</div>
      </div>
    </div>
  </div>

  <div class="row">
    <table>
      <thead><tr><th>カテゴリ</th><th>プラン（回数）</th><th>金額</th><th>操作</th></tr></thead>
      <tbody id="combo-body-c"></tbody>
    </table>
  </div>

  <div class="row">
    <label>組み合わせ合計（税込・自動反映）
      <input id="combo-total-c" readonly value="0">
    </label>
  </div>

  <h2>分割シミュレーション（キャンペーン）</h2>

  <div class="row">
    <label>プラン総額（税込）
      <input type="number" id="total-campaign" value="0" readonly>
    </label>
    <label>頭金（1000円以上・千円単位）
      <input type="number" id="downPayment-campaign" min="0" step="1000" placeholder="例: 100000">
    </label>
  </div>

  <div class="row">
    <label>支払い回数（1,2,6〜50回）
      <select id="months-campaign"></select>
    </label>

    <label>ボーナス利用
      <select id="bonus-toggle-campaign">
        <option value="off">なし</option>
        <option value="on">あり</option>
      </select>
    </label>
  </div>

  <div class="row" id="bonus-row-campaign" style="display:none">
    <label>ボーナス加算金（千円単位/月）
      <input type="number" id="bonus-campaign" min="0" step="1000" placeholder="例: 20000">
    </label>
    <label>ボーナス（夏）
      <select id="bonus-summer-campaign">
        <option value="">選択なし</option>
        <option value="6">6月</option>
        <option value="7">7月</option>
        <option value="8">8月</option>
      </select>
    </label>
    <label>ボーナス（冬）
      <select id="bonus-winter-campaign">
        <option value="">選択なし</option>
        <option value="12">12月</option>
        <option value="1">1月</option>
      </select>
    </label>
  </div>

  <div class="row">
    <div class="cards two-col" style="width:100%">
      <div class="card"><h3>初回のお支払い</h3><p id="first-campaign">¥0</p></div>
      <div class="card highlight"><h3>2回目以降のお支払い</h3><p id="monthly-campaign">¥0</p></div>
      <div class="card"><h3>クレジット残高</h3><p id="principal-campaign">¥0</p></div>
      <div class="card"><h3>分割手数料</h3><p id="fee-campaign">¥0</p></div>
      <div class="card"><h3>分割支払い金合計</h3><p id="sum-campaign">¥0</p></div>
      <div class="card"><h3>支払総額（頭金含む）</h3><p id="grand-campaign">¥0</p></div>
    </div>
  </div>

  <div class="row">
    <div class="cards two-col" style="width:100%">
      <div class="card"><h3>初回お支払い年月（2か月後）</h3><p id="first-date-campaign">-</p></div>
      <div class="card"><h3>最終お支払い年月</h3><p id="last-date-campaign">-</p></div>
      <div class="card"><h3>ボーナス情報</h3><p id="bonus-info-campaign">-</p></div>
      <div class="card"><h3>バリデーション</h3><p id="alerts-campaign">-</p></div>
    </div>
  </div>

  <div id="err-campaign" style="color:#b00020;"></div>
</div>
  </section>
  <!-- 通常タブ -->
  <section id="tab-normal" class="tab-content">
    <div class="wrap">
      <h2>通常料金（12月版）</h2>
code
Code
<div class="row">
    <label>カテゴリ
      <select id="normal-cat"></select>
    </label>
    <label>部位（プラン名）
      <select id="normal-item"></select>
    </label>
  </div>

  <div class="row">
    <label>回数
      <select id="normal-course">
        <option value="1">1回</option>
        <option value="4">4回</option>
        <option value="8">8回</option>
        <option value="12">12回</option>
      </select>
    </label>

    <label>金額（税込）
      <input id="normal-price" readonly value="0">
    </label>

    <div class="btn-wrap">
      <button id="normal-apply" type="button">この金額で計算</button>
    </div>
  </div>

  <div class="row">
    <div class="btn-wrap">
      <button id="normal-add" type="button">＋追加</button>
    </div>
  </div>

  <div class="row">
    <table>
      <thead><tr><th>カテゴリ</th><th>部位</th><th>回数</th><th>金額</th><th>操作</th></tr></thead>
      <tbody id="normal-combo-body"></tbody>
    </table>
  </div>

  <div class="row">
    <label>テーブル合計（税込）
      <input id="normal-combo-total" readonly value="0">
    </label>
    <div class="btn-wrap">
      <button id="normal-cart-apply" type="button">テーブル合計で計算</button>
    </div>
  </div>

  <div class="row">
    <label>プラン総額（税込）
      <input type="number" id="total-normal" value="0" readonly>
    </label>
    <label>頭金（1000円以上・千円単位）
      <input type="number" id="downPayment-normal" min="0" step="1000" placeholder="例: 100000">
    </label>
  </div>

  <div class="row">
    <label>支払い回数（1,2,6〜50回）
      <select id="months-normal"></select>
    </label>
    <label>ボーナス利用
      <select id="bonus-toggle-normal">
        <option value="off">なし</option>
        <option value="on">あり</option>
      </select>
    </label>
  </div>

  <div class="row" id="bonus-row-normal" style="display:none">
    <label>ボーナス加算金（千円単位/月）
      <input type="number" id="bonus-normal" min="0" step="1000" placeholder="例:20000">
    </label>
    <label>ボーナス（夏）
      <select id="bonus-summer-normal">
        <option value="">選択なし</option>
        <option value="6">6月</option>
        <option value="7">7月</option>
        <option value="8">8月</option>
      </select>
    </label>
    <label>ボーナス（冬）
      <select id="bonus-winter-normal">
        <option value="">選択なし</option>
        <option value="12">12月</option>
        <option value="1">1月</option>
      </select>
    </label>
  </div>

  <div class="row">
    <div class="cards two-col" style="width:100%">
      <div class="card"><h3>初回のお支払い</h3><p id="first-normal">¥0</p></div>
      <div class="card highlight"><h3>2回目以降のお支払い</h3><p id="monthly-normal">¥0</p></div>
      <div class="card"><h3>クレジット残高</h3><p id="principal-normal">¥0</p></div>
      <div class="card"><h3>分割手数料</h3><p id="fee-normal">¥0</p></div>
      <div class="card"><h3>分割支払い金合計</h3><p id="sum-normal">¥0</p></div>
      <div class="card"><h3>支払総額（頭金含む）</h3><p id="grand-normal">¥0</p></div>
    </div>
  </div>

  <div class="row">
    <div class="cards two-col" style="width:100%">
      <div class="card"><h3>初回お支払い年月（2か月後）</h3><p id="first-date-normal">-</p></div>
      <div class="card"><h3>最終お支払い年月</h3><p id="last-date-normal">-</p></div>
      <div class="card"><h3>ボーナス情報</h3><p id="bonus-info-normal">-</p></div>
      <div class="card"><h3>バリデーション</h3><p id="alerts-normal">-</p></div>
    </div>
  </div>

  <div id="err-normal" style="color:#b00020;"></div>
</div>
  </section>
  <!-- 共通フッター -->
  <footer style="text-align:center;padding:20px;color:#888;">© <span id="year"></span> MEN'S CLEAR</footer>
<!-- ===== Part 3 / 3: 完全な JavaScript 実装（これを先ほどのファイルの最後に追加してください） ===== -->
<script>
(function(){
  'use strict';

  /* -------------------------
     ユーティリティ
  ------------------------- */
  function q(sel, root){ return (root||document).querySelector(sel); }
  function qa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function toYen(n){ return '¥' + (Math.max(0, Math.floor(n || 0))).toLocaleString(); }
  function num(v){ return Number(v || 0); }
  function nowYmPlusMonths(m){
    var d=new Date();
    d.setMonth(d.getMonth()+m);
    return d;
  }
  function ymString(d){ if(!d) return '-'; return d.getFullYear() + '年' + String(d.getMonth()+1).padStart(2,'0') + '月'; }

  /* -------------------------
     プランデータ（ユーザー指定の12月版）
  ------------------------- */
  var CAMPAIGN_DEFS = {
    'ヒゲ': {
      '8回': 110660,
      '12回': 143770,
      '12回安心': 277750,
      '12回安心+EP': 339800,
      '12回安心+EP+プラ': 389800
    },
    'フェイス': {
      '8回': 158430,
      '12回': 197000,
      '12回安心': 326890,
      '12回安心+EP': 374260,
      '12回安心+EP+プラ': 424260
    },
    'どこでも脱毛20分': {
      '8回': 129800,
      '12回': 178000,
      '12回安心': 309000,
      '12回安心+プラ': 359000
    },
    '陰部': {
      '4回': 98300,
      '8回': 194420,
      '12回': 279970,
      '12回安心': 448860,
      '12回安心+プラ': 498860
    },
    'どこでも脱毛40分': {
      '4回': 119800,
      '8回': 228000,
      '12回': 329000,
      '12回安心': 569000,
      '12回安心+プラ': 619000
    },
    '全身+ヒゲor陰部': {
      '4回': 196800,
      '8回': 359750,
      '12回': 506480,
      '12回安心': 795160,
      '12回安心プラ': 845160
    },
    '全身オール': {
      '4回': 213400,
      '8回': 396640,
      '12回': 554420,
      '12回安心': 887750,
      '12回安心+プラ+EP': 1054420
    }
  };

  /* -------------------------
     学割ロジック
     - 25% off capped at ¥100,000
     - 最終は10円単位切り捨て（元コードに合わせ）
  ------------------------- */
  function applyStudentDiscount(original){
    var cap = 100000;
    var pct = Math.floor(original * 0.25);
    var disc = Math.min(pct, cap);
    var after = original - disc;
    // 10円単位に丸め（元のコード風）
    return Math.floor(after / 10) * 10;
  }

  /* -------------------------
     分割計算ロジック（共通）
     ルール：
       - 年利相当（擬似）で rate = 0.008（元コードに合わせ）
       - fee = floor(principal * rate * months)
       - bonus回数 = years * (夏?1:0 + 冬?1:0)
       - bonusTotal = bonus * cnt
       - monthly = floor(((sum - bonusTotal) / months) / 100) * 100
       - first = (sum - bonusTotal) - monthly*(months-1)
       - first payment scheduled 2 months後の月
  ------------------------- */
  function computeSplit(total, down, months, bonusPerMonth, summerMonth, winterMonth){
    var rate = 0.008;
    var principal = Math.max(0, total - down);
    var fee = Math.floor(principal * rate * months);
    var years = Math.ceil(Math.max(1, months) / 12);
    var summerOn = ['6','7','8'].indexOf(String(summerMonth)) >= 0 ? 1 : 0;
    var winterOn = ['12','1'].indexOf(String(winterMonth)) >= 0 ? 1 : 0;
    var slots = summerOn + winterOn;
    var bonusCount = bonusPerMonth > 0 ? years * slots : 0;
    var sum = principal + fee;
    var bonusTotal = bonusPerMonth * bonusCount;
    // avoid negative
    var adjustedSum = Math.max(0, sum - bonusTotal);
    var monthly = Math.floor((adjustedSum / Math.max(1, months)) / 100) * 100;
    var first = adjustedSum - monthly * (Math.max(1, months) - 1);
    var now = new Date();
    var firstDate = new Date(now.getFullYear(), now.getMonth() + 2, 1);
    var lastDate = new Date(firstDate.getFullYear(), firstDate.getMonth() + (Math.max(1, months) - 1), 1);
    // find first bonus date if exists
    var bonusFirstDate = null;
    if(bonusPerMonth > 0 && slots > 0){
      for(var i=0;i<months;i++){
        var mm = ((firstDate.getMonth()+i) % 12) + 1;
        if(String(mm) === String(summerMonth) || String(mm) === String(winterMonth)){
          bonusFirstDate = new Date(firstDate.getFullYear(), firstDate.getMonth()+i, 1);
          break;
        }
      }
    }
    return {
      principal: principal,
      fee: fee,
      sum: sum,
      monthly: monthly,
      first: first,
      grand: sum + down,
      firstDate:firstDate,
      lastDate:lastDate,
      bonusCount: bonusCount,
      bonusTotal: bonusTotal,
      bonusFirstDate: bonusFirstDate
    };
  }

  /* -------------------------
     UI ヘルパー（months select の初期化）
  ------------------------- */
  function fillMonths(select){
    if(!select) return;
    select.innerHTML = '';
    var empty = document.createElement('option'); empty.value=''; empty.textContent='回数を選択'; select.appendChild(empty);
    [1,2].concat(Array.from({length:45},(_,i)=>i+6)).forEach(function(m){
      var op = document.createElement('option'); op.value = String(m); op.textContent = m + '回'; select.appendChild(op);
    });
  }

  /* -------------------------
     タブ切替
  ------------------------- */
  qa('.tab').forEach(function(tab){
    tab.addEventListener('click', function(){
      var t = tab.dataset.tab;
      qa('.tab').forEach(x=>x.classList.remove('active'));
      tab.classList.add('active');
      qa('.tab-content').forEach(c=>c.classList.remove('active'));
      var pane = document.getElementById('tab-' + t);
      if(pane) pane.classList.add('active');
    });
  });

  // year footer
  var yearSpan = q('#year');
  if(yearSpan) yearSpan.textContent = new Date().getFullYear();

  /* -------------------------
     キャンペーンタブのロジック
  ------------------------- */
  // tiers: 3 個のプランスロット
  var tiers = { matu: [], take: [], ume: [] };
  var currentTier = 'matu';

  // DOM refs
  var catSelectC = q('#cat-select-c');
  var planSelectC = q('#plan-select-c');
  var selectedPriceC = q('#selected-plan-price-c');
  var addPlanC = q('#add-plan-c');
  var comboBodyC = q('#combo-body-c');
  var comboTotalC = q('#combo-total-c');

  var priceMatsu = q('#price-matsu'), priceTake = q('#price-take'), priceUme = q('#price-ume');
  var planlistMatsu = q('#planlist-matsu'), planlistTake = q('#planlist-take'), planlistUme = q('#planlist-ume');

  // financing DOM
  var totalCampaign = q('#total-campaign');
  var downCampaign = q('#downPayment-campaign');
  var monthsCampaign = q('#months-campaign');
  var bonusToggleCampaign = q('#bonus-toggle-campaign');
  var bonusRowCampaign = q('#bonus-row-campaign');
  var bonusCampaign = q('#bonus-campaign');
  var bonusSummerCampaign = q('#bonus-summer-campaign');
  var bonusWinterCampaign = q('#bonus-winter-campaign');

  var firstCampaign = q('#first-campaign'), monthlyCampaign = q('#monthly-campaign'),
      principalCampaign = q('#principal-campaign'), feeCampaign = q('#fee-campaign'),
      sumCampaign = q('#sum-campaign'), grandCampaign = q('#grand-campaign'),
      firstDateCampaign = q('#first-date-campaign'), lastDateCampaign = q('#last-date-campaign'),
      bonusInfoCampaign = q('#bonus-info-campaign'), alertsCampaign = q('#alerts-campaign');

  // pill buttons to switch tiers
  qa('.pill').forEach(function(p){
    p.addEventListener('click', function(){
      qa('.pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      currentTier = p.dataset.target === 'matsu' ? 'matu' : (p.dataset.target==='take' ? 'take' : 'ume');
      renderCombo();
      refreshAllCampaign();
    });
  });

  // card click to change current tier
  q('#card-matsu').addEventListener('click', function(){ currentTier='matu'; qa('.pill').forEach(x=>x.classList.remove('active')); qa('.pill')[0].classList.add('active'); renderCombo(); refreshAllCampaign(); });
  q('#card-take').addEventListener('click', function(){ currentTier='take'; qa('.pill').forEach(x=>x.classList.remove('active')); qa('.pill')[1].classList.add('active'); renderCombo(); refreshAllCampaign(); });
  q('#card-ume').addEventListener('click', function(){ currentTier='ume'; qa('.pill').forEach(x=>x.classList.remove('active')); qa('.pill')[2].classList.add('active'); renderCombo(); refreshAllCampaign(); });

  // populate category and plan selects
  function populatePlanSelects(){
    // categories
    Object.keys(CAMPAIGN_DEFS).forEach(function(cat){
      var op = document.createElement('option'); op.value = cat; op.textContent = cat; catSelectC.appendChild(op);
    });
    // set plans for initial category
    refreshPlanOptions();
  }
  function refreshPlanOptions(){
    var cat = catSelectC.value;
    planSelectC.innerHTML = '';
    var dict = CAMPAIGN_DEFS[cat] || {};
    Object.keys(dict).forEach(function(k){
      var op = document.createElement('option'); op.value = k; op.textContent = k; planSelectC.appendChild(op);
    });
    updateSelectedPriceC();
  }
  function updateSelectedPriceC(){
    var cat = catSelectC.value;
    var plan = planSelectC.value;
    var amt = (CAMPAIGN_DEFS[cat]||{})[plan] || 0;
    selectedPriceC.value = amt.toLocaleString();
  }

  // add plan to current tier
  addPlanC.addEventListener('click', function(){
    var cat = catSelectC.value;
    var plan = planSelectC.value;
    var amt = (CAMPAIGN_DEFS[cat]||{})[plan] || 0;
    if(!amt){
      q('#err-campaign').textContent = '選択したプランの金額が見つかりません';
      return;
    }
    q('#err-campaign').textContent = '';
    var obj = { cat: cat, name: plan, amount: amt, orig: amt, student: false, disc: 0 };
    tiers[currentTier].push(obj);
    renderCombo();
    refreshAllCampaign();
  });

  // render combo table for current tier
  function renderCombo(){
    comboBodyC.innerHTML = '';
    (tiers[currentTier]||[]).forEach(function(it, i){
      var tr = document.createElement('tr');
      tr.setAttribute('data-idx', i);
      var tdCat = document.createElement('td'); tdCat.textContent = it.cat;
      var tdName = document.createElement('td'); tdName.textContent = it.name;
      var tdAmt = document.createElement('td'); tdAmt.textContent = toYen(it.amount);
      var tdOps = document.createElement('td');
      // buttons: 値修正, 学割, 削除
      var btnEdit = document.createElement('button'); btnEdit.textContent = '値修正'; btnEdit.style.margin='2px';
      var btnStudent = document.createElement('button'); btnStudent.textContent = '学'; btnStudent.style.margin='2px';
      var btnDel = document.createElement('button'); btnDel.textContent = '削除'; btnDel.style.margin='2px';
      tdOps.appendChild(btnEdit); tdOps.appendChild(btnStudent); tdOps.appendChild(btnDel);

      tr.appendChild(tdCat); tr.appendChild(tdName); tr.appendChild(tdAmt); tr.appendChild(tdOps);
      comboBodyC.appendChild(tr);

      // edit button shows prompt for percent discount
      btnEdit.addEventListener('click', function(){
        var rate = prompt('割引率を入力してください（%） 例: 10 → 10%');
        if(rate === null) return;
        var r = Math.max(0, Math.min(100, Math.floor(Number(rate) || 0)));
        var orig = Number(it.orig || it.amount || 0);
        var newAmt = Math.floor(orig * (100 - r) / 100);
        it.amount = newAmt;
        it.disc = Math.max(0, orig - newAmt);
        it.student = false;
        renderCombo();
        refreshAllCampaign();
      });

      // student discount
      btnStudent.addEventListener('click', function(){
        var orig = Number(it.orig || it.amount || 0);
        var newAmt = applyStudentDiscount(orig);
        it.amount = newAmt;
        it.disc = Math.max(0, orig - newAmt);
        it.student = true;
        renderCombo();
        refreshAllCampaign();
      });

      // delete
      btnDel.addEventListener('click', function(){
        tiers[currentTier].splice(i,1);
        renderCombo();
        refreshAllCampaign();
      });
    });

    // update combo total display for currently selected tier
    comboTotalC.value = (tiers[currentTier]||[]).reduce((s,x)=>s+Number(x.amount||0),0).toLocaleString();
  }

  // helper: sum for a tier
  function sumTier(key){
    return (tiers[key]||[]).reduce(function(s,x){ return s + Number(x.amount||0); }, 0);
  }

  // update plan cards (three columns)
  function refreshCards(){
    var sM = sumTier('matu'), sT = sumTier('take'), sU = sumTier('ume');
    priceMatsu.textContent = toYen(sM);
    priceTake.textContent = toYen(sT);
    priceUme.textContent = toYen(sU);

    planlistMatsu.textContent = listText('matu');
    planlistTake.textContent = listText('take');
    planlistUme.textContent = listText('ume');

    // if inputs for financing incomplete, show '—' for monthly etc in separate rendering
  }

  function listText(key){
    var arr = (tiers[key]||[]).map(function(x){
      var head = '['+x.cat+'] ' + x.name;
      var o = Number(x.orig||0);
      var a = Number(x.amount||0);
      var d = Math.max(0, o - a);
      var tail = x.student ? '（学割適用）' : (d>0 ? '（割引）' : '');
      if(d>0) return head + ' ' + toYen(o) + ' → -' + toYen(d) + ' = ' + toYen(a) + tail;
      return head + ' ' + toYen(a) + tail;
    });
    return arr.length ? arr.join('\n') : '（プラン未選択）';
  }

  // validate inputs presence for campaign computing
  function campaignInputsComplete(){
    var needBonus = bonusToggleCampaign && bonusToggleCampaign.value === 'on';
    if(!downCampaign || downCampaign.value === '') return false;
    if(!monthsCampaign || monthsCampaign.value === '') return false;
    if(needBonus && (!bonusCampaign || bonusCampaign.value === '' || Number(bonusCampaign.value) === 0)) return false;
    return true;
  }

  // build alerts like earlier (bonus limit etc.)
  function buildCampaignAlerts(total){
    var alerts = [];
    if(!(total>0)) return alerts;
    if(!campaignInputsComplete()) return alerts;
    var down = Number(downCampaign.value || 0);
    var months = Math.max(1, Number(monthsCampaign.value || 0));
    var bonus = Math.max(0, Number(bonusCampaign.value || 0));
    var summer = bonusSummerCampaign ? bonusSummerCampaign.value : '';
    var winter = bonusWinterCampaign ? bonusWinterCampaign.value : '';
    var r = computeSplit(total, down, months, bonus, summer, winter);
    if(bonus > 0 && r.bonusCount > 0){
      var limit = Math.floor(Math.max(0, total - down) * 0.5);
      if(r.bonusTotal > limit){
        var per = r.bonusCount > 0 ? Math.floor(limit / r.bonusCount) : 0;
        alerts.push('ボーナス加算金合計はクレジット残金の50%以下にしてください。上限合計: ' + toYen(limit) + ' ／ 1回あたり目安: ' + toYen(per));
      }
    }
    if(r.monthly < 1700) alerts.push('2回目以降分割払金が1700円以上になるように頭金、回数、ボーナスをご設定ください');
    return alerts;
  }

  // main refresh for campaign tab
  function refreshAllCampaign(){
    // update totals per tier and global total
    refreshCards();
    var totalAll = sumTier('matu') + sumTier('take') + sumTier('ume');
    if(totalCampaign) totalCampaign.value = totalAll;
    // compute financing if inputs present
    var down = Number(downCampaign && downCampaign.value || 0);
    var months = Math.max(1, Number(monthsCampaign && monthsCampaign.value || 0));
    var bonus = Math.max(0, Number(bonusCampaign && bonusCampaign.value || 0));
    var summer = bonusSummerCampaign ? bonusSummerCampaign.value : '';
    var winter = bonusWinterCampaign ? bonusWinterCampaign.value : '';
    var r = computeSplit(totalAll, down, months, bonus, summer, winter);

    if(firstCampaign) firstCampaign.textContent = toYen(r.first);
    if(monthlyCampaign) monthlyCampaign.textContent = toYen(r.monthly);
    if(principalCampaign) principalCampaign.textContent = toYen(r.principal);
    if(feeCampaign) feeCampaign.textContent = toYen(r.fee);
    if(sumCampaign) sumCampaign.textContent = toYen(r.sum);
    if(grandCampaign) grandCampaign.textContent = toYen(r.grand);
    if(firstDateCampaign) firstDateCampaign.textContent = ymString(r.firstDate);
    if(lastDateCampaign) lastDateCampaign.textContent = ymString(r.lastDate);
    if(bonusInfoCampaign) bonusInfoCampaign.textContent = (bonus>0 ? ('ボーナス回数: ' + r.bonusCount + '回 / 合計: ' + toYen(r.bonusTotal) + (r.bonusFirstDate ? (' / 初回: ' + ymString(r.bonusFirstDate)) : '') ) : 'なし');
    var alerts = buildCampaignAlerts(totalAll);
    if(alertsCampaign) alertsCampaign.textContent = alerts.length ? alerts.join('\n') : 'OK';
  }

  // initialize months select and bonus row toggle
  fillMonths(monthsCampaign);
  // show/hide bonus row
  if(bonusToggleCampaign){
    bonusToggleCampaign.addEventListener('change', function(){
      if(bonusRowCampaign) bonusRowCampaign.style.display = bonusToggleCampaign.value === 'on' ? 'flex' : 'none';
      refreshAllCampaign();
    });
  }

  // change handlers
  if(catSelectC) catSelectC.addEventListener('change', function(){ refreshPlanOptions(); });
  if(planSelectC) planSelectC.addEventListener('change', updateSelectedPriceC);
  if(monthsCampaign) monthsCampaign.addEventListener('change', refreshAllCampaign);
  if(downCampaign) downCampaign.addEventListener('input', refreshAllCampaign);
  if(bonusCampaign) bonusCampaign.addEventListener('input', refreshAllCampaign);
  if(bonusSummerCampaign) bonusSummerCampaign.addEventListener('change', refreshAllCampaign);
  if(bonusWinterCampaign) bonusWinterCampaign.addEventListener('change', refreshAllCampaign);

  // initial populate
  populatePlanSelects();
  renderCombo();
  refreshAllCampaign();

  /* -------------------------
     通常タブ（normal）ロジック
  ------------------------- */
  // Data for normal tab - we will provide a condensed mapping using campaign pricing where reasonable.
  var NORMAL_DEFS = {
    '顔・首全体': {
      '口下': { '1': 10800, '4': 38800, '8': 77760, '12':116400 },
      '両ほほ': { '1': 10800, '4': 38800, '8': 77760, '12':116400 },
      '両もみあげ': { '1': 10800, '4': 38800, '8': 77760, '12':116400 },
      '鼻下': { '1': 10800, '4': 38800, '8': 77760, '12':116400 },
      'あご': { '1': 10800, '4': 38800, '8': 77760, '12':116400 },
      'あご下・首': { '1':11880, '4':42700, '8':85400, '12':128100 },
      'まゆ上・眉間': { '1':11880, '4':42700, '8':85400, '12':128100 },
      '小鼻': { '1':10800, '4':38800, '8':77760, '12':116400 }
    },
    '上半身': {
      '手の指': {'1':3800,'4':13600,'8':27200,'12':40800},
      '手の甲': {'1':5300,'4':19000,'8':38000,'12':57000},
      'ひじ下': {'1':10800,'4':38800,'8':77600,'12':116400},
      'ひじ上': {'1':10800,'4':38800,'8':77600,'12':116400},
      '胸全体': {'1':10800,'4':38800,'8':77600,'12':116400},
      '腹全体': {'1':10800,'4':38800,'8':77600,'12':116400},
      '乳輪周り': {'1':5300,'4':19000,'8':38000,'12':57000},
      'へそ周り': {'1':5300,'4':19000,'8':38000,'12':57000},
      '両わき': {'1':5300,'4':19000,'8':38000,'12':57000},
      '肩': {'1':5300,'4':19000,'8':38000,'12':57000},
      '背中上': {'1':6500,'4':23400,'8':46800,'12':70200},
      '背中下': {'1':6500,'4':23400,'8':46800,'12':70200}
    },
    '下半身': {
      '足の指': {'1':9200,'4':33100,'8':66200,'12':99300},
      '足の甲': {'1':14200,'4':51100,'8':102200,'12':153300},
      'ひざ下': {'1':32000,'4':115200,'8':230400,'12':345600},
      'ひざ上': {'1':32000,'4':115200,'8':230400,'12':345600}
    },
    'デリケート': {
      'Vライン': {'1':22000,'4':79200,'8':158400,'12':237600},
      'Iライン': {'1':22000,'4':79200,'8':158400,'12':237600},
      'Oライン': {'1':22000,'4':79200,'8':158400,'12':237600},
      'おしり': {'1':22000,'4':79200,'8':158400,'12':237600}
    }
  };

  // DOM refs normal
  var normalCat = q('#normal-cat'), normalItem = q('#normal-item'), normalCourse = q('#normal-course'), normalPrice = q('#normal-price');
  var normalApply = q('#normal-apply'), normalAdd = q('#normal-add'), normalComboBody = q('#normal-combo-body'), normalComboTotal = q('#normal-combo-total'), normalCartApply = q('#normal-cart-apply');
  var totalNormal = q('#total-normal'), downNormal = q('#downPayment-normal'), monthsNormal = q('#months-normal'), bonusToggleNormal = q('#bonus-toggle-normal'), bonusRowNormal = q('#bonus-row-normal');
  var bonusNormal = q('#bonus-normal'), bonusSummerNormal = q('#bonus-summer-normal'), bonusWinterNormal = q('#bonus-winter-normal');
  var firstNormal = q('#first-normal'), monthlyNormal = q('#monthly-normal'), principalNormal = q('#principal-normal'), feeNormal = q('#fee-normal'), sumNormal = q('#sum-normal'), grandNormal = q('#grand-normal'), firstDateNormal = q('#first-date-normal'), lastDateNormal = q('#last-date-normal'), bonusInfoNormal = q('#bonus-info-normal'), alertsNormal = q('#alerts-normal');

  // populate normal categories
  function populateNormalCats(){
    Object.keys(NORMAL_DEFS).forEach(function(cat){
      var op = document.createElement('option'); op.value = cat; op.textContent = cat; normalCat.appendChild(op);
    });
    refreshNormalItems();
  }
  function listNormalItems(cat){
    var names = Object.keys(NORMAL_DEFS[cat] || {});
    names.sort();
    // add '全部位' override naming similar to original
    if(cat === 'デリケート'){
      names.unshift('全部位（VIOおしり）');
    } else {
      names.unshift('全部位');
    }
    return names;
  }
  function refreshNormalItems(){
    var cat = normalCat.value;
    normalItem.innerHTML = '';
    var items = listNormalItems(cat);
    items.forEach(function(name){
      var op = document.createElement('option'); op.value = name; op.textContent = name; normalItem.appendChild(op);
    });
    syncNormalPrice();
  }
  // price getter for normal - if '全部位', sum parts
  function getNormalPrice(cat, item, course){
    if(item === '全部位' || item === '全部位（VIOおしり）'){
      var sum = 0;
      Object.keys(NORMAL_DEFS[cat] || {}).forEach(function(k){ sum += Number((NORMAL_DEFS[cat][k]||{})[course] || 0); });
      // allow override if desired (kept simple)
      return sum;
    } else {
      return Number(((NORMAL_DEFS[cat]||{})[item]||{})[course] || 0);
    }
  }
  function syncNormalPrice(){
    var p = getNormalPrice(normalCat.value, normalItem.value, normalCourse.value);
    normalPrice.value = p.toLocaleString();
  }

  // add row to normal combos
  normalAdd.addEventListener('click', function(){
    var cat = normalCat.value, item = normalItem.value, course = normalCourse.value;
    var amt = getNormalPrice(cat, item, course);
    var tr = document.createElement('tr');
    tr.setAttribute('data-amt', String(amt));
    tr.innerHTML = '<td>'+cat+'</td><td>'+item+'</td><td>'+course+'回</td><td>'+toYen(amt)+'</td><td><button class="del">削除</button></td>';
    normalComboBody.appendChild(tr);
    updateNormalTableTotal();
  });
  // delete handler
  normalComboBody.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('del')){
      var tr = e.target.closest('tr'); if(tr){ tr.remove(); updateNormalTableTotal(); }
    }
  });
  function updateNormalTableTotal(){
    var s = 0;
    qa('#normal-combo-body tr').forEach(function(tr){ s += Number(tr.getAttribute('data-amt') || 0); });
    normalComboTotal.value = s.toLocaleString();
  }
  // apply table total to total-normal
  normalCartApply.addEventListener('click', function(){
    var v = Number((normalComboTotal.value || '0').toString().replace(/[^0-9]/g,'')) || 0;
    if(totalNormal) totalNormal.value = v;
    refreshNormalSplit();
  });
  // quick set total from single price
  normalApply.addEventListener('click', function(){
    var v = Number((normalPrice.value || '0').toString().replace(/[^0-9]/g,'')) || 0;
    if(totalNormal) totalNormal.value = v;
    refreshNormalSplit();
  });

  // fill months select
  fillMonths(monthsNormal);

  // show/hide bonus row
  if(bonusToggleNormal){
    bonusToggleNormal.addEventListener('change', function(){
      if(bonusRowNormal) bonusRowNormal.style.display = bonusToggleNormal.value === 'on' ? 'flex' : 'none';
      refreshNormalSplit();
    });
  }

  // refresh calculation for normal tab
  function refreshNormalSplit(){
    var total = Number(totalNormal.value || 0);
    var down = Number(downNormal && downNormal.value || 0);
    var months = Math.max(1, Number(monthsNormal && monthsNormal.value || 0));
    var bonus = Math.max(0, Number(bonusNormal && bonusNormal.value || 0));
    var summer = bonusSummerNormal ? bonusSummerNormal.value : '';
    var winter = bonusWinterNormal ? bonusWinterNormal.value : '';
    var r = computeSplit(total, down, months, bonus, summer, winter);

    if(firstNormal) firstNormal.textContent = toYen(r.first);
    if(monthlyNormal) monthlyNormal.textContent = toYen(r.monthly);
    if(principalNormal) principalNormal.textContent = toYen(r.principal);
    if(feeNormal) feeNormal.textContent = toYen(r.fee);
    if(sumNormal) sumNormal.textContent = toYen(r.sum);
    if(grandNormal) grandNormal.textContent = toYen(r.grand);
    if(firstDateNormal) firstDateNormal.textContent = ymString(r.firstDate);
    if(lastDateNormal) lastDateNormal.textContent = ymString(r.lastDate);
    if(bonusInfoNormal) bonusInfoNormal.textContent = (bonus>0 ? ('ボーナス回数: ' + r.bonusCount + '回 / 合計: ' + toYen(r.bonusTotal)) : 'なし');

    // alerts
    var alerts = [];
    if(bonus > 0 && r.bonusCount > 0){
      var limit = Math.floor(Math.max(0, total - down) * 0.5);
      if(r.bonusTotal > limit){
        var per = Math.floor(limit / Math.max(1, r.bonusCount));
        alerts.push('ボーナス加算金合計はクレジット残金の50%以下にしてください（上限合計: ' + toYen(limit) + ' / 目安: ' + toYen(per) + '）');
      }
    }
    if(r.monthly < 1700) alerts.push('2回目以降分割払金が1700円以上になるように頭金、回数、ボーナスをご設定ください');
    if(alertsNormal) alertsNormal.textContent = alerts.length ? alerts.join('\n') : 'OK';
  }

  // wire input events for normal tab
  [normalCat, normalItem, normalCourse].forEach(function(el){
    if(el) el.addEventListener('change', syncNormalPrice);
  });
  [downNormal, monthsNormal, bonusNormal, bonusSummerNormal, bonusWinterNormal].forEach(function(el){
    if(el) { el.addEventListener('input', refreshNormalSplit); el.addEventListener('change', refreshNormalSplit); }
  });

  // initial populate and refresh
  populateNormalCats();
  updateNormalTableTotal();
  refreshNormalSplit();

  /* -------------------------
     小さな UX 改善
  ------------------------- */
  // When months selects are empty on load, ensure filled
  fillMonths(monthsCampaign);
  fillMonths(monthsNormal);

  // make sure plan select in campaign is refreshed initially
  if(catSelectC) refreshPlanOptions();

  // attach basic keyboard-friendly focus style for interactive buttons (optional)
  qa('button').forEach(function(b){ b.addEventListener('focus', function(){ b.style.outline='2px solid rgba(11,79,168,0.25)'; }); b.addEventListener('blur', function(){ b.style.outline='none'; }); });

  // expose some objects for console debugging (optional)
  window.__sim = {
    tiers: tiers,
    CAMPAIGN_DEFS: CAMPAIGN_DEFS,
    NORMAL_DEFS: NORMAL_DEFS,
    applyStudentDiscount: applyStudentDiscount,
    computeSplit: computeSplit,
    refreshAllCampaign: refreshAllCampaign,
    refreshNormalSplit: refreshNormalSplit
  };

})();
</script>
</body>
</html>
